pipeline {
    agent any

    environment {
        // =========================
        // TARGET SERVER DETAILS
        // =========================
        TARGET_USER = "ubuntu"
        TARGET_IP   = "56.228.22.165"

        // =========================
        // APPLICATION DETAILS
        // =========================
        APP_DIR        = "/home/ubuntu/myapp"
        IMAGE_NAME     = "myapp-img"
        CONTAINER_NAME = "myapp-container"
        APP_PORT       = "5000"

        // =========================
        // JENKINS CREDENTIALS
        // =========================
        SSH_CRED_ID = "jen-cred"
        NGROK_TOKEN = credentials("NGROK_AUTH_TOKEN")
    }

    stages {

        stage("Checkout Source Code") {
            steps {
                checkout scm
            }
        }

        stage("Upload Code to Target Server") {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${TARGET_USER}@${TARGET_IP} 'mkdir -p ${APP_DIR}'
                    scp -o StrictHostKeyChecking=no -r . ${TARGET_USER}@${TARGET_IP}:${APP_DIR}
                    """
                }
            }
        }

        stage("Build Docker Image on Target Server") {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh """
                    ssh ${TARGET_USER}@${TARGET_IP} '
                        cd ${APP_DIR} &&
                        docker build -t ${IMAGE_NAME} .
                    '
                    """
                }
            }
        }

        stage("Run Docker Container") {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh """
                    ssh ${TARGET_USER}@${TARGET_IP} '
                        docker rm -f ${CONTAINER_NAME} || true
                        docker run -d \
                          --name ${CONTAINER_NAME} \
                          -p ${APP_PORT}:${APP_PORT} \
                          ${IMAGE_NAME}
                    '
                    """
                }
            }
        }

        stage("Start ngrok HTTPS Tunnel") {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh """
                    ssh ${TARGET_USER}@${TARGET_IP} '
                        pkill ngrok || true
                        ngrok config add-authtoken ${NGROK_TOKEN}
                        nohup ngrok http ${APP_PORT} > ngrok.log 2>&1 &
                    '
                    """
                }
            }
        }

        stage("Show Public HTTPS URL") {
            steps {
                sshagent(credentials: [env.SSH_CRED_ID]) {
                    sh """
                    ssh ${TARGET_USER}@${TARGET_IP} '
                        sleep 6
                        curl -s http://127.0.0.1:4040/api/tunnels \
                        | jq -r ".tunnels[0].public_url"
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment complete — copy the HTTPS ngrok URL above and open in browser."
            echo "Enjoy Your Game  link :   https://uncertificated-untrembling-lance.ngrok-free.dev/ "
        }
        failure {
            echo "❌ Pipeline failed — check Jenkins logs."
        }
    }
}
